# DDL Contract

All state must exist in these tables.

## 1. Canonical Tables
* `plan_cycles` (id, authority_id, plan_name, status, weight_hint, effective_from, effective_to, superseded_by_cycle_id [nullable], is_active, metadata_jsonb, created_at, updated_at)
* `ingest_batches` (id, source_system, authority_id [nullable], plan_cycle_id [nullable], started_at, completed_at [nullable], status, notes [nullable], inputs_jsonb, outputs_jsonb)
* `ingest_runs` (id, ingest_batch_id, authority_id [nullable], plan_cycle_id [nullable], pipeline_version [nullable], model_ids_jsonb, prompt_hashes_jsonb, status, started_at, ended_at [nullable], inputs_jsonb, outputs_jsonb, error_text [nullable])
* `ingest_run_aliases` (id, scope_type, scope_key, alias, run_id, set_at, set_by [nullable], notes [nullable])
* `ingest_jobs` (id, ingest_batch_id [nullable], authority_id, plan_cycle_id [nullable], job_type, status, inputs_jsonb, outputs_jsonb, created_at, started_at [nullable], completed_at [nullable], error_text [nullable])
* `ingest_run_steps` (id, ingest_batch_id [nullable], run_id [nullable], step_name, status, started_at [nullable], ended_at [nullable], inputs_jsonb, outputs_jsonb, error_text [nullable])
* `documents` (id, authority_id, ingest_batch_id [nullable], plan_cycle_id [nullable], run_id [nullable], document_status [nullable], weight_hint [nullable], effective_from [nullable], effective_to [nullable], is_active, superseded_by_document_id [nullable], confidence_hint [nullable], uncertainty_note [nullable], metadata, blob_path, raw_blob_path [nullable], raw_sha256 [nullable], raw_bytes [nullable], raw_content_type [nullable], raw_source_uri [nullable], raw_artifact_id [nullable])
* `parse_bundles` (id, ingest_job_id [nullable], ingest_batch_id [nullable], run_id [nullable], document_id [nullable], schema_version, blob_path, status, metadata_jsonb, created_at)
* `pages` (id, document_id, page_number, ingest_batch_id [nullable], run_id [nullable], source_artifact_id [nullable], render_blob_path [nullable], render_format [nullable], render_dpi [nullable], render_width [nullable], render_height [nullable], render_tier [nullable], render_reason [nullable], metadata)
* `chunks` (id, document_id, page_number, ingest_batch_id [nullable], run_id [nullable], source_artifact_id [nullable], text, bbox, bbox_quality [nullable], type, section_path, span_start [nullable], span_end [nullable], span_quality [nullable], evidence_ref_id [nullable], metadata)
* `layout_blocks` (id, document_id, page_number, ingest_batch_id [nullable], run_id [nullable], source_artifact_id [nullable], block_id, block_type, text, bbox, bbox_quality [nullable], section_path [nullable], span_start [nullable], span_end [nullable], span_quality [nullable], evidence_ref_id [nullable], metadata_jsonb)
* `document_tables` (id, document_id, page_number, ingest_batch_id [nullable], run_id [nullable], source_artifact_id [nullable], table_id, bbox [nullable], bbox_quality [nullable], rows_jsonb, evidence_ref_id [nullable], metadata_jsonb)
* `vector_paths` (id, document_id, page_number, ingest_batch_id [nullable], run_id [nullable], source_artifact_id [nullable], path_id, path_type, geometry_jsonb [nullable], bbox [nullable], bbox_quality [nullable], tool_run_id [nullable], metadata_jsonb)
* `unit_embeddings` (id, unit_type, unit_id, embedding, embedding_model_id, embedding_dim [nullable], created_at, tool_run_id [nullable], run_id [nullable])
* `visual_assets` (id, document_id, page_number, ingest_batch_id [nullable], run_id [nullable], source_artifact_id [nullable], asset_type, blob_path, evidence_ref_id [nullable], metadata)
* `visual_features` (id, visual_asset_id, run_id [nullable], feature_type, geometry_jsonb, confidence, evidence_ref_id [nullable], tool_run_id [nullable], metadata_jsonb)
* `segmentation_masks` (id, visual_asset_id, run_id [nullable], label, prompt, mask_artifact_path, mask_rle_jsonb [nullable], bbox [nullable], bbox_quality [nullable], confidence, tool_run_id [nullable], created_at)
* `visual_asset_regions` (id, visual_asset_id, run_id [nullable], region_type, bbox [nullable], bbox_quality [nullable], mask_id [nullable], caption_text [nullable], evidence_ref_id [nullable], metadata_jsonb, created_at)
* `visual_asset_links` (id, visual_asset_id, run_id [nullable], target_type, target_id, link_type, evidence_ref_id [nullable], tool_run_id [nullable], metadata_jsonb, created_at)
* `visual_semantic_outputs` (id, visual_asset_id, run_id [nullable], schema_version, asset_type [nullable], asset_subtype [nullable], canonical_facts_jsonb, asset_specific_facts_jsonb, assertions_jsonb, agent_findings_jsonb, material_index_jsonb, metadata_jsonb, tool_run_id [nullable], created_at)
* `frames` (id, run_id [nullable], frame_type, epsg [nullable], description [nullable], metadata_jsonb, created_at)
* `transforms` (id, run_id [nullable], from_frame_id, to_frame_id, method, matrix, matrix_shape, uncertainty_score, control_point_ids_jsonb, tool_run_id [nullable], metadata_jsonb, created_at)
* `control_points` (id, run_id [nullable], transform_id, src_jsonb, dst_jsonb, residual [nullable], weight [nullable], created_at)
* `projection_artifacts` (id, run_id [nullable], transform_id, artifact_type, artifact_path, evidence_ref_id [nullable], tool_run_id [nullable], metadata_jsonb, created_at)
* `policy_sections` (id, document_id, ingest_batch_id [nullable], run_id [nullable], source_artifact_id [nullable], policy_code [nullable], title [nullable], section_path [nullable], heading_text [nullable], text, page_start [nullable], page_end [nullable], span_start [nullable], span_end [nullable], span_quality [nullable], evidence_ref_id [nullable], metadata_jsonb)
* `policy_clauses` (id, policy_section_id, run_id [nullable], clause_ref [nullable], text, page_number [nullable], span_start [nullable], span_end [nullable], span_quality [nullable], speech_act_jsonb, conditions_jsonb, subject [nullable], object [nullable], evidence_ref_id [nullable], source_artifact_id [nullable], metadata_jsonb)
* `policy_clause_mentions` (id, policy_clause_id, run_id [nullable], mention_text, mention_kind, evidence_refs_jsonb, resolved_entity_type [nullable], resolved_entity_id [nullable], resolution_confidence [nullable], tool_run_id [nullable], metadata_jsonb, created_at)
* `policy_definitions` (id, policy_section_id [nullable], policy_clause_id [nullable], run_id [nullable], term, definition_text, evidence_ref_id [nullable], source_artifact_id [nullable], metadata_jsonb)
* `policy_targets` (id, policy_section_id [nullable], policy_clause_id [nullable], run_id [nullable], metric [nullable], value [nullable], unit [nullable], timeframe [nullable], geography_ref [nullable], raw_text [nullable], evidence_ref_id [nullable], source_artifact_id [nullable], metadata_jsonb)
* `policy_monitoring_hooks` (id, policy_section_id [nullable], policy_clause_id [nullable], run_id [nullable], indicator_text, evidence_ref_id [nullable], source_artifact_id [nullable], metadata_jsonb)
* `sites` (id, geometry_polygon, metadata)
* `site_fingerprints` (id, site_id, plan_cycle_id [nullable], authority_id [nullable], fingerprint_jsonb, tool_run_id [nullable], created_at, updated_at, is_current, superseded_by_fingerprint_id [nullable], confidence_hint [nullable], uncertainty_note [nullable])
* `spatial_features` (id, authority_id [nullable], ingest_batch_id [nullable], type, spatial_scope [nullable], is_active, effective_from [nullable], effective_to [nullable], confidence_hint [nullable], uncertainty_note [nullable], geometry, properties)
* `plan_projects` (id, authority_id, process_model_id, title, status, current_stage_id, metadata_jsonb, created_at, updated_at)
* `rule_packs` (id, pack_key, name, jurisdiction, system, current_version_id [nullable], created_at)
* `rule_pack_versions` (id, rule_pack_id, version, effective_from, effective_to [nullable], content_jsonb, created_at)
* `rule_requirements` (id, rule_pack_version_id, requirement_key, requirement_type, culp_stage_id [nullable], lifecycle_state_id [nullable], params_jsonb, severity, created_at)
* `rule_checks` (id, rule_pack_version_id, check_key, check_type, from_state_id [nullable], to_state_id [nullable], params_jsonb, severity, created_at)
* `plan_workflow_states` (id, plan_project_id, rule_pack_version_id, state_id, state_started_at, state_updated_at, metadata_jsonb, created_at)
* `workflow_checklists` (id, plan_project_id, rule_pack_version_id, state_id, checklist_key, status, completed_at [nullable], metadata_jsonb, created_at)
* `workflow_transitions` (id, plan_project_id, rule_pack_version_id, from_state_id, to_state_id, transitioned_at, actor_type, actor_id [nullable], notes [nullable], metadata_jsonb)
* `timetables` (id, plan_project_id, status, public_title, plain_summary, data_jsonb, published_at [nullable], created_at, updated_at)
* `milestones` (id, timetable_id, milestone_key, title, due_date, status, metadata_jsonb, created_at, updated_at)
* `timetable_reviews` (id, timetable_id, review_status, reviewed_at, reviewer, notes [nullable], metadata_jsonb)
* `consultations` (id, plan_project_id, consultation_type, title, status, open_at [nullable], close_at [nullable], channels_jsonb, documents_jsonb, created_at, updated_at)
* `invitees` (id, consultation_id, category, name, contact_jsonb, invited_at [nullable], method [nullable], metadata_jsonb)
* `representations` (id, consultation_id, submitter_jsonb, content_text, tags_jsonb, site_refs_jsonb, policy_refs_jsonb, files_jsonb, submitted_at [nullable], public_redacted_text [nullable], status)
* `issue_clusters` (id, consultation_id, title, summary, tags_jsonb, representation_ids_jsonb, created_at)
* `consultation_summaries` (id, consultation_id, summary_jsonb, status, published_at [nullable], created_at, updated_at)
* `evidence_items` (id, plan_project_id, title, evidence_type, publisher, published_date [nullable], geography [nullable], plan_period [nullable], status, source_url [nullable], file_hash [nullable], storage_path [nullable], methodology_summary [nullable], quality_flags_jsonb, dependencies_jsonb, created_at, updated_at)
* `evidence_gaps` (id, plan_project_id, gap_type, triggered_by [nullable], owner [nullable], due_date [nullable], risk_level [nullable], resolution_evidence_item_id [nullable], status, created_at, updated_at)
* `trace_links` (id, from_type, from_id, to_type, to_id, link_type, confidence [nullable], notes [nullable], created_by, created_at)
* `site_drafts` (id, plan_project_id, geometry_polygon [nullable], status, metadata_jsonb, expires_at [nullable], created_at, updated_at)
* `site_categories` (id, plan_project_id, name, description [nullable], metadata_jsonb, created_at, updated_at)
* `site_assessments` (id, site_id, plan_project_id, stage, suitability, availability, achievability, notes [nullable], metadata_jsonb, created_at, updated_at)
* `site_scores` (id, site_assessment_id, dimension, rag, rationale [nullable], evidence_refs_jsonb, created_at)
* `mitigations` (id, site_assessment_id, description, status, evidence_refs_jsonb, created_at)
* `allocation_decisions` (id, plan_project_id, site_id, decision_status, reason [nullable], evidence_refs_jsonb, created_at, updated_at)
* `decision_logs` (id, allocation_decision_id, stage, changed_at, summary, metadata_jsonb)
* `stage4_summary_rows` (id, plan_project_id, site_id, category, capacity [nullable], phasing [nullable], rag_overall [nullable], rag_suitability [nullable], rag_availability [nullable], rag_achievability [nullable], justification [nullable], deliverable_status [nullable], created_at, updated_at)
* `gateway_submissions` (id, plan_project_id, gateway_type, status, submitted_at [nullable], pack_jsonb, created_at, updated_at)
* `gateway_outcomes` (id, gateway_submission_id, outcome, findings_jsonb, published_at [nullable], created_at)
* `statement_compliance` (id, plan_project_id, gateway_submission_id [nullable], statement_jsonb, status, created_at, updated_at)
* `statement_soundness` (id, plan_project_id, gateway_submission_id [nullable], statement_jsonb, status, created_at, updated_at)
* `readiness_for_exam` (id, plan_project_id, gateway_submission_id [nullable], statement_jsonb, status, created_at, updated_at)
* `examination_events` (id, plan_project_id, event_type, event_date, details_jsonb, created_at)
* `adoption_statements` (id, plan_project_id, statement_jsonb, published_at [nullable], created_at)
* `publications` (id, plan_project_id, artefact_key, authored_artefact_id [nullable], artifact_path [nullable], title, status, publish_target, is_immutable, published_at [nullable], metadata_jsonb, created_at, updated_at)
* `publication_assets` (id, publication_id, asset_path, content_type, metadata_jsonb, created_at)
* `culp_artefacts` (id, plan_project_id, culp_stage_id, artefact_key, status, authored_artefact_id [nullable], artifact_path [nullable], evidence_refs_jsonb, produced_by_run_id [nullable], tool_run_ids_jsonb, created_at, updated_at, notes)
* `authored_artefacts` (id, workspace, plan_project_id [nullable], application_id [nullable], culp_stage_id [nullable], artefact_type, title, status, content_format, content_jsonb, exported_artifact_path [nullable], supersedes_artefact_id [nullable], created_by, created_at, updated_at)
* `scenarios` (id, plan_project_id, culp_stage_id, title, summary, state_vector_jsonb, parent_scenario_id [nullable], status, created_by, created_at, updated_at)
* `scenario_sets` (id, plan_project_id, culp_stage_id, political_framing_ids_jsonb, scenario_ids_jsonb, tab_ids_jsonb, selected_tab_id [nullable], selection_rationale [nullable], selected_at [nullable])
* `scenario_framing_tabs` (id, scenario_set_id, scenario_id, political_framing_id, framing_id [nullable], run_id [nullable], status, trajectory_id [nullable], judgement_sheet_ref [nullable], updated_at, dependency_hash [nullable], dependency_snapshot_jsonb, cache_expires_at [nullable], last_run_started_at [nullable], last_run_completed_at [nullable])
* `trajectories` (id, scenario_id, framing_id, position_statement, explicit_assumptions_jsonb, key_evidence_refs_jsonb, judgement_sheet_jsonb, created_at)
* `scenario_deltas` (id, scenario_set_id, from_scenario_id, to_scenario_id, delta_jsonb, created_at)
* `scenario_evaluations` (id, scenario_id, evaluation_jsonb, created_at)

## 2. Development Management (Casework) Tables
* `applications` (id, authority_id, reference, site_geometry, proposal_metadata, status, received_at, plan_project_id [nullable], plan_cycle_id [nullable])
* `pre_applications` (id, authority_id, reference, site_geometry [nullable], submission_metadata_jsonb, status, received_at)
* `application_revisions` (id, application_id, revision_metadata, received_at)
* `application_consultations` (id, application_id, consultee, response_text, received_at, metadata)
* `conditions` (id, application_id, condition_text, reason_text, status)
* `decisions` (id, application_id, outcome, decision_date, officer_report_document_id)

## 3. Monitoring & Delivery Tables
* `monitoring_events` (id, authority_id, event_type, event_date, payload_jsonb, provenance)
* `monitoring_timeseries` (id, authority_id, metric_id, period, value, provenance)
* `adoption_baselines` (id, authority_id, adoption_date, policies_map_ref, metrics_jsonb, provenance)

## 4. Procedure Tables (Traceable Judgement)
* `runs` (id, profile, culp_stage_id, anchors_jsonb, created_at)
* `move_events` (id, run_id, move_type, sequence, status, created_at, started_at, ended_at, backtracked_from_move_id, backtrack_reason, confidence_hint [nullable], uncertainty_note [nullable], inputs_jsonb, outputs_jsonb, evidence_refs_considered_jsonb, assumptions_introduced_jsonb, uncertainty_remaining_jsonb, tool_run_ids_jsonb)
* `retrieval_frames` (id, run_id, move_type, version, is_current, superseded_by_frame_id [nullable], tool_run_id [nullable], frame_jsonb, created_at)
* `tool_requests` (id, run_id, move_event_id [nullable], requested_by_move_type [nullable], tool_name, instrument_id [nullable], purpose, inputs_jsonb, blocking, status, created_at, started_at [nullable], completed_at [nullable], tool_run_id [nullable], outputs_jsonb, evidence_refs_jsonb, error_text [nullable])
* `reasoning_evidence_links` (id, run_id [nullable], move_event_id, evidence_ref_id, role, note [nullable], created_at)
* `material_considerations` (id, run_id, move_event_id [nullable], consideration_type, statement, evidence_refs_jsonb, confidence_hint [nullable], uncertainty_note [nullable], created_at)
* `audit_events` (id, timestamp, event_type, actor_type, actor_id, run_id, plan_project_id, culp_stage_id, scenario_id, tool_run_id, payload_jsonb)

## 5. Knowledge Graph Tables (The "Join Fabric")
* `kg_node` (node_id [PK], node_type, props_jsonb, canonical_fk [nullable])
* `kg_edge` (edge_id [PK], src_id [FK], dst_id [FK], edge_type, edge_class [nullable], resolve_method [nullable], props_jsonb, evidence_ref_id, tool_run_id, run_id [nullable])

## 6. Provenance Tables
* `artifacts` (id, type, path)
* `tool_runs` (id, ingest_batch_id [nullable], run_id [nullable], tool_name, inputs_logged, outputs_logged, status, started_at, ended_at, confidence_hint [nullable], uncertainty_note [nullable])
* `evidence_refs` (id, run_id [nullable], source_type, source_id, fragment_id)

## 7. Prompt Library Tables (Governance)
Prompts are versioned, auditable governance artefacts (see `agents/PROMPT_LIBRARY_SPEC.md`).
* `prompts` (prompt_id, name, purpose, created_at, created_by)
* `prompt_versions` (prompt_id, prompt_version, template, input_schema_ref, output_schema_ref, created_at, created_by, diff_from_version)

## 8. Snapshot Tables (Audit / diff)
Snapshots are optional but recommended to support “what information was before the decision-maker?” questions.
* `snapshots` (snapshot_id, plan_project_id [nullable], application_id [nullable], run_id [nullable], label, state_jsonb, created_at, created_by [nullable])
* `snapshot_diffs` (diff_id, from_snapshot_id, to_snapshot_id, diff_jsonb, created_at)

## Invariants
* Every `kg_edge` must have a valid `evidence_ref_id` OR `tool_run_id` (provenance is mandatory).
* `kg_node.canonical_fk` links strict graph nodes to rich canonical table rows.
* `plan_cycles` lifecycle: per `authority_id`, at most one active adopted cycle (`status='adopted'`) and at most one active emerging cycle (`status in {'draft','emerging','submitted','examination'}`) at a time (use `is_active=false` + `superseded_by_cycle_id` to retain history).
